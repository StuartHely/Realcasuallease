# =============================================================================
# CasualLease AWS ALB Ingress
# Uses AWS Load Balancer Controller for Application Load Balancer
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: casuallease-ingress
  namespace: casuallease
  labels:
    app: casuallease
    environment: production
  annotations:
    # -----------------------------------------------------------------------------
    # AWS Load Balancer Controller Configuration
    # -----------------------------------------------------------------------------
    kubernetes.io/ingress.class: alb
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    
    # -----------------------------------------------------------------------------
    # SSL/TLS Configuration
    # Uncomment and set your ACM certificate ARN for HTTPS
    # -----------------------------------------------------------------------------
    # alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-southeast-2:ACCOUNT_ID:certificate/CERT_ID
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
    alb.ingress.kubernetes.io/ssl-redirect: "443"
    alb.ingress.kubernetes.io/ssl-policy: ELBSecurityPolicy-TLS13-1-2-2021-06
    
    # -----------------------------------------------------------------------------
    # Health Check Configuration
    # -----------------------------------------------------------------------------
    alb.ingress.kubernetes.io/healthcheck-path: /health
    alb.ingress.kubernetes.io/healthcheck-port: "3000"
    alb.ingress.kubernetes.io/healthcheck-protocol: HTTP
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: "30"
    alb.ingress.kubernetes.io/healthcheck-timeout-seconds: "10"
    alb.ingress.kubernetes.io/healthy-threshold-count: "2"
    alb.ingress.kubernetes.io/unhealthy-threshold-count: "3"
    alb.ingress.kubernetes.io/success-codes: "200"
    
    # -----------------------------------------------------------------------------
    # Load Balancer Attributes
    # -----------------------------------------------------------------------------
    alb.ingress.kubernetes.io/load-balancer-attributes: |
      idle_timeout.timeout_seconds=60,
      routing.http2.enabled=true,
      routing.http.drop_invalid_header_fields.enabled=true
    
    # -----------------------------------------------------------------------------
    # Target Group Attributes
    # -----------------------------------------------------------------------------
    alb.ingress.kubernetes.io/target-group-attributes: |
      deregistration_delay.timeout_seconds=30,
      stickiness.enabled=false
    
    # -----------------------------------------------------------------------------
    # Security Groups (Optional)
    # Uncomment to specify security groups
    # -----------------------------------------------------------------------------
    # alb.ingress.kubernetes.io/security-groups: sg-xxxxxxxxx
    
    # -----------------------------------------------------------------------------
    # WAF Integration (Optional)
    # Uncomment to attach a WAF WebACL
    # -----------------------------------------------------------------------------
    # alb.ingress.kubernetes.io/wafv2-acl-arn: arn:aws:wafv2:ap-southeast-2:ACCOUNT_ID:regional/webacl/NAME/ID
    
    # -----------------------------------------------------------------------------
    # Tags for AWS Resources
    # -----------------------------------------------------------------------------
    alb.ingress.kubernetes.io/tags: Environment=production,Application=casuallease

spec:
  # Ingress class for AWS ALB
  ingressClassName: alb
  
  rules:
    # Default rule - handles all hosts
    - http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: casuallease
                port:
                  number: 80
  
  # -----------------------------------------------------------------------------
  # TLS Configuration (Optional)
  # Uncomment when you have a domain and SSL certificate
  # -----------------------------------------------------------------------------
  # tls:
  #   - hosts:
  #       - casuallease.example.com
  #     secretName: casuallease-tls  # Only needed if not using ACM

---
# =============================================================================
# Optional: IngressClass for AWS ALB
# May already exist in your cluster if AWS LB Controller is installed
# =============================================================================

# apiVersion: networking.k8s.io/v1
# kind: IngressClass
# metadata:
#   name: alb
#   annotations:
#     ingressclass.kubernetes.io/is-default-class: "true"
# spec:
#   controller: ingress.k8s.aws/alb
